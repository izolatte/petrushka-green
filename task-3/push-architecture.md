# Задание 3: Архитектура PUSH-уведомлений (верхний уровень)

## Пояснения по компонентам схемы
### Mobile App
Клиентское приложение пользователя
- получает pushToken от платформы (FCM для Android / APNs для iOS)
- отправляет токен на бэк (чтобы backend знал, куда слать пуши)
- принимает уведомления от провайдеров (FCM/APNs) и показывает пользователю 

### Device Token Store (хранилище токенов устройств)
Компонент для хранения связки `userId → token(ы) устройства`. Хранит токены устройств. Один пользователь может иметь несколько устройств, следовательно несколько токенов.

**Варианты реализации:**  
- либо как **отдельный микросервис** `Device Registry / Device Token Service`  
- либо как часть `Notification Service` (таблица в его базе)

**Что хранит:**  
- userId  
- pushToken  
- platform (ios/android)  
- дата обновления токена  
- признак “токен активен/не активен”

### Domain Services (наши микросервисы на бэке)
Бизнес-логика интернет-магазина. Источник событий, от которых могут отправляться пуши.

Примеры событий:
- OrderCanceled (заказ отменен)
- OrderStatusChanged (статус заказа поменялся)
- CartAbandoned (корзина долгое время пустует)
- MarketingCampaignStarted (рекламная кампания)

Сами эти сервисы не должны напрямую отправлять пуш в FCM/APNs, иначе получится сильная связность и будет сложно масштабировать.

### Event Bus
Инфраструктурный компонент (шина событий между сервисами) для доставки событий между сервисами.

**Варианты реализации:**  
- Kafka / RabbitMQ / AWS SNS/SQS / Google PubSub и т.д.

Для чего:
- чтобы сервисы не вызывали друг друга напрямую  
- чтобы пуши отправлялись асинхронно и устойчиво  
- чтобы новые типы пушей добавлялись без изменения старых сервисов

### Scheduler (отложенные пуши)
Компонент, который отвечает за отложенные уведомления. Нужен для сценариев, где пуш приходит через время. Например в случае с пустующей корзиной.

**Варианты реализации:**
1) **Отдельный сервис-воркер** `Notification Scheduler`  
   - работает отдельно  
   - периодически проверяет условия и создаёт событие (например `CartAbandoned`)  

2) **Часть Notification Service** (как встроенный воркер внутри сервиса)  
   - проще, но хуже масштабируется  
   - подходит для небольших систем 

### Notification Builder
Центральный компонент, который принимает события и решает “отправляем пуш или нет”.

**Как реализуется:** отдельный микросервис в составе подсистемы уведомлений.

**Что делает:**
- получает событие из Event Bus (или от Scheduler)  
- применяет правила:
  - какие пуши включены у пользователя (настройки)
  - какая категория (сервисный / маркетинговый)
  - quiet hours (если есть)  
- формирует текст пуша (возможно по шаблону и локализации)
- создаёт задачу на отправку и кладёт её в очередь (Notification Pull Service)

### Notification Pull Service
Очередь задач на отправку пушей.
Нужна для:
- устойчивости если много событий, чтобы не падать от нагрузки
- если провайдер (FCM/APNs) временно недоступен, чтобы повторить отправку позже

**Как реализуется:** RabbitMQ / Kafka topic / SQS / Redis streams (в зависимости от инфраструктуры).

### Push Sender
Компонент, который физически отправляет уведомление во внешние PUSH-провайдеры.

**Как реализуется:**
- отдельный сервис-воркер, который читает задачи из Send Queue  

**Что делает:**
- берёт задачу из очереди
- отправляет в FCM (для Android) или APNs (для iOS)
- обрабатывает ошибки
- при необходимости делает retry
- если токен протух, помечает токен невалидным в Device Token Store

```mermaid
flowchart LR
  App["Mobile App<br/>(iOS / Android)"]

  TokenStore["Device Token Store<br/>(хранение токенов устройств)"]

  Services["Domain Services<br/>(Cart / Orders / Marketing)"]
  Bus["Event Bus<br/>(Kafka / RabbitMQ)"]
  Scheduler["Scheduler<br/>(отложенные события)"]

  Notif["Notification Builder<br/>(правила + текст пуша)"]
  Pull["Notification Pull Service<br/>(очередь отправки)"]
  Sender["Push Sender"]
  Providers["PUSH Providers<br/>(FCM / APNs)"]

  App -->|"регистрация pushToken"| TokenStore

  Services -->|"события"| Bus
  Bus --> Notif
  Bus --> Scheduler
  Scheduler -->|"событие в нужный момент"| Notif

  Notif --> TokenStore
  Notif -->|"задача на отправку"| Pull
  Pull --> Sender
  Sender --> Providers
  Providers --> App

